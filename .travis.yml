language: generic
sudo: required
git:
  depth: 1
services:
  - postgresql


addons_shortcuts:
  addons_pg96_gcc48: &pg96_gcc48
    postgresql: "9.6"
    apt:
      sources: ["boost-latest","ubuntu-toolchain-r-test"]
      packages:
      - g++-4.8
      - postgresql-9.6-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev
  addons_pg96_gcc49: &pg96_gcc49
    postgresql: "9.6"
    apt:
      sources: ["boost-latest","ubuntu-toolchain-r-test"]
      packages:
      - g++-4.9
      - postgresql-9.6-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev
  addons_pg96_gcc6: &pg96_gcc6
    postgresql: "9.6"
    apt:
      sources: ["boost-latest","ubuntu-toolchain-r-test"]
      packages:
      - g++-6
      - postgresql-9.6-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev
  addons_pg96_gcc7: &pg96_gcc7
    postgresql: "9.6"
    apt:
      sources: ["ubuntu-toolchain-r-test"]
      packages:
      - g++-7
      - postgresql-9.6-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev
  addons_pg96_gcc8: &pg96_gcc8
    postgresql: "9.6"
    apt:
      sources: ["boost-latest","ubuntu-toolchain-r-test"]
      packages:
      - g++-8
      - postgresql-9.6-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev
  addons_pg92_clang38: &pg92_clang38
    postgresql: "9.2"
    apt:
      sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-trusty-3.8']
      packages:
      - clang-3.8
      - postgresql-9.2-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev
  addons_pg93_clang40: &pg93_clang40
    postgresql: "9.3"
    apt:
      sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-trusty-4.0']
      packages:
      - clang-4.0
      - postgresql-9.3-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev
  addons_pg94_clang50: &pg94_clang50
    postgresql: "9.4"
    apt:
      sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-trusty-5.0']
      packages:
      - clang-5.0
      - postgresql-9.4-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev
  addons_pg96_clang60: &pg96_clang60
    postgresql: "9.6"
    apt:
      update: true
      sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-trusty-6.0']
      packages:
      - clang-6.0
      - gcc-4.8
      - postgresql-9.6-postgis-2.3
      - python-psycopg2
      - libexpat1-dev
      - libpq-dev
      - libbz2-dev
      - libproj-dev
      - lua5.2
      - liblua5.2-dev
      - libluajit-5.1-dev
      - libboost1.55-dev
      - libboost-system1.55-dev
      - libboost-filesystem1.55-dev

      
# env: T="...."     //  unique test id, test name
matrix:
  include:
  # ---- Linux + CLANG ---------------------------
    - os: linux
      compiler: "clang-3.8"
      env: T="clang38_pg92_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror" LUAJIT_OPTION="OFF"
           CC=clang-3.8 CXX=clang++-3.8
      addons: *pg92_clang38

    - os: linux
      compiler: "clang-4.0"
      env: T="clang40_pg93_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror" LUAJIT_OPTION="OFF"
           CC=clang-4.0 CXX=clang++-4.0
      addons: *pg93_clang40

    - os: linux
      compiler: "clang-5.0"
      env: T="clang50_pg94_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror" LUAJIT_OPTION="OFF"
           CC=clang-5.0 CXX=clang++-5.0
      addons: *pg94_pg94_clang50

    - os: linux
      compiler: "clang-5.0"
      env: T="clang50_dbtest_luajit" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror" LUAJIT_OPTION="ON"
           CC=clang-5.0 CXX=clang++-5.0
      addons: *pg94_clang50

    - os: linux
      compiler: "clang-6.0"
      env: T="clang60_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror" LUAJIT_OPTION="OFF"
           CC=clang-6.0 CXX=clang++-6.0
      addons: *pg96_clang60

    - os: linux
      compiler: "clang-6.0"
      env: T="clang60asan_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror  -fsanitize=address" LUAJIT_OPTION="OFF"
           CC=clang-6.0 CXX=clang++-6.0
           ASAN_OPTIONS="verbosity=1:log_threads=1"
           LSAN_OPTIONS="verbosity=1:log_threads=1"
      addons: *pg96_clang60

    - os: linux
      compiler: "clang-6.0"
      env: T="clang60asan_luajit_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror  -fsanitize=address" LUAJIT_OPTION="ON"
           CC=clang-6.0 CXX=clang++-6.0
           ASAN_OPTIONS="verbosity=1:log_threads=1"
           LSAN_OPTIONS="verbosity=1:log_threads=1"
      addons: *pg96_clang60

  # ---- OSX + CLANG ---------------------------

    - os: osx
      compiler: clang
      env: T="osx_clang_NoDB" RUNTEST="-L NoDB"
           CXXFLAGS="-pedantic -Werror " LUAJIT_OPTION="OFF"
      before_install:
        - brew install lua;
      before_script:
        - xml2-config --version
        - proj | head -n1
        - lua -v


  # ---- Linux + GCC ---------------------------
    - os: linux
      compiler: "gcc-4.8"
      env: T="gcc4asan_NoDB" RUNTEST="-L NoDB"
           CXXFLAGS="-pedantic -Werror -fsanitize=address" LUAJIT_OPTION="OFF"
           CC=gcc-4.8 CXX=g++-4.8
      addons: *pg96_gcc48

    - os: linux
      compiler: "gcc-4.9"
      env: T="gcc4asan_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror -fsanitize=address" LUAJIT_OPTION="OFF"
           CC=gcc-4.9 CXX=g++-4.9
      addons: *pg96_gcc49

    - os: linux
      compiler: "gcc-4.9"
      env: T="gcc4asan_dbtest_luajit" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror -fsanitize=address" LUAJIT_OPTION="ON"
           CC=gcc-4.9 CXX=g++-4.9
      addons: *pg96_gcc49

    - os: linux
      compiler: gcc-6
      env: T="gcc6_dbtest_luajit" RUNTEST="#All-dbtest" CXXFLAGS=" -pedantic -Werror" LUAJIT_OPTION="ON"
           CC=gcc-6 CXX=g++-6
      addons: *pg96_gcc6

    - os: linux
      compiler: gcc-7
      env: T="gcc7_dbtest_luajit" RUNTEST="#All-dbtest" CXXFLAGS=" -pedantic -Werror" LUAJIT_OPTION="ON"
           CC=gcc-7 CXX=g++-7
      addons: *pg96_gcc7

## not working:  gcc-7 + fsanitize=address
##    - os: linux
##      compiler: gcc-7
##      env: T="gcc7asan_dbtest_luajit" RUNTEST="#All-dbtest" LUAJIT_OPTION="ON"
##           CXXFLAGS=" -pedantic -Werror -fsanitize=address"
##           ASAN_OPTIONS="verbosity=1:log_threads=1"
##           LSAN_OPTIONS="verbosity=1:log_threads=1"
##           CC=gcc-7 CXX=g++-7
##      addons: *pg96_gcc7

    - os: linux
      compiler: gcc-8
      env: T="gcc8_dbtest_luajit" RUNTEST="#All-dbtest" CXXFLAGS=" -pedantic -Werror" LUAJIT_OPTION="ON"
           CC=gcc-8 CXX=g++-8
      addons: *pg96_gcc8


  allow_failures:

    - os: linux
      env: T="clang50_pg94_dbtest_luajit" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror" LUAJIT_OPTION="ON"
           CC=clang-5.0 CXX=clang++-5.0

    - os: linux
      env: T="clang60asan_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror  -fsanitize=address" LUAJIT_OPTION="OFF"
           CC=clang-6.0 CXX=clang++-6.0
           ASAN_OPTIONS="verbosity=1:log_threads=1"
           LSAN_OPTIONS="verbosity=1:log_threads=1"

    - os: linux
      env: T="clang60asan_luajit_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror  -fsanitize=address" LUAJIT_OPTION="ON"
           CC=clang-6.0 CXX=clang++-6.0
           ASAN_OPTIONS="verbosity=1:log_threads=1"
           LSAN_OPTIONS="verbosity=1:log_threads=1"

    - os: linux
      env: T="gcc4asan_dbtest" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror -fsanitize=address" LUAJIT_OPTION="OFF"
           CC=gcc-4.9 CXX=g++-4.9

    - os: linux
      env: T="gcc4asan_dbtest_luajit" RUNTEST="#All-db"
           CXXFLAGS="-pedantic -Werror -fsanitize=address" LUAJIT_OPTION="ON"
           CC=gcc-4.9 CXX=g++-4.9

    - os: linux
      env: T="gcc6_dbtest_luajit" RUNTEST="#All-dbtest" CXXFLAGS=" -pedantic -Werror" LUAJIT_OPTION="ON"
           CC=gcc-6 CXX=g++-6

    - os: linux
      env: T="gcc7_dbtest_luajit" RUNTEST="#All-dbtest" CXXFLAGS=" -pedantic -Werror" LUAJIT_OPTION="ON"
           CC=gcc-7 CXX=g++-7

    - os: linux
      env: T="gcc8_dbtest_luajit" RUNTEST="#All-dbtest" CXXFLAGS=" -pedantic -Werror" LUAJIT_OPTION="ON"
           CC=gcc-8 CXX=g++-8


before_install:
  - sudo mkdir -p /extra/pg/tablespacetest
  - sudo chown postgres:postgres /extra/pg/tablespacetest
  - dpkg -l | grep -E 'lua|proj|xml|bz2|postgis|zlib|boost|expat'  # checking available versions
before_script:
  - psql -U postgres -c "SELECT version()"
  - psql -U postgres -c "CREATE TABLESPACE tablespacetest LOCATION '/extra/pg/tablespacetest'"
  - psql -U postgres -c "CREATE EXTENSION postgis"
  - psql -U postgres -c "CREATE EXTENSION hstore"
  - psql -U postgres -c "SELECT PostGIS_Full_Version()"
  - $CXX --version
  - xml2-config --version
  - proj | head -n1
  - lua -v
script:
  - mkdir build && cd build
  - cmake .. -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug -DWITH_LUAJIT=$LUAJIT_OPTION
  - make -j2
  - echo "Running tests ... "
  - if [[ $RUNTEST ]]; then ctest -VV $RUNTEST; fi
after_failure:
  - # rerun make, but verbosely
    make VERBOSE=1



# end of .travis